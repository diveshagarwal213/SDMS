<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDMS Data Management</title>
    <script src="jquery.js"></script>
    <link rel="stylesheet" href="css/dataManagementNew.css">
    
</head>
<body>
    <h1 class="heading"> <a href="index.php">SDMS</a> New Data Management</h1>
    <h2 class="heading">Insert New Data</h2> 
    <div id="formDiv">
        <form id="topicText">
            <div id="one" >
                <div id="one1">
                    <label for="Cname">Cource Name</label> 
                    <select  id="Cname" name="c_id">
                    </select>
                    <div id="cyear">
                        <p>Select Cource Year </p>
                        <label for="Cyear_1">1</label>
                        <input type="radio" id="Cyear_1" name="c_year" value="1">
                        <label for="Cyear_2">2</label>
                        <input type="radio" id="Cyear_2" name="c_year" value="2">
                        <label for="Cyear_3">3</label>
                        <input type="radio" id="Cyear_3" name="c_year" value="3">
                        <label for="Cyear_4">4</label>
                        <input type="radio" id="Cyear_4" name="c_year" value="4">
                    </div>
                </div>
                <div id="one2">
                    <label for="Csubject">subjects</label> 
                    <select  id="Csubject" name="s_id">
                        <option value="">select subject</option>     
                    </select>
                    <div id="sunit">
                        <p>select subject unit : 
                        <label for="unit_1">1</label>
                        <input type="radio" id="unit_1" name="s_unit" value="1">
                        <label for="unit_2">2</label>
                        <input type="radio" id="unit_2" name="s_unit" value="2">
                        <label for="unit_3">3</label>
                        <input type="radio" id="unit_3" name="s_unit" value="3">
                        <label for="unit_4">4</label>
                        <input type="radio" id="unit_4" name="s_unit" value="4">
                        </p>
                    </div>
                </div>
            </div>
            
            <label for="title">Toipc Title<span class="orange">*</span></label>
            <input type="text" id="title" name="title">
            <br>
            
            <label for="h_one">First Heading<span class="orange">*</span></label>
            <input type="text" id="h_one" name="h_one" >
            <br>
            <label for="t_one">Text body</label> <br>
            <textarea id="t_one" cols="30" rows="10" name="t_one"></textarea>
            <br>
            
            <label for="h_two">second Heading</label>
            <input type="text" id="h_two" name="h_two">
            <br>
            <label for="t_two">Text body 2</label>
            <br> 
            <textarea id="t_two" cols="30" rows="10" name="t_two"></textarea>
            <br>
            
            <label for="h_three">third Heading</label>
            <input type="text" id="h_three" name="h_three">
            <br>
            <label for="t_three">Text body 3</label>
            <br>
            <textarea  id="t_three" cols="30" rows="10" name="t_three"></textarea>
            <br>
            <input type="submit" value="save ok" id="save_TopicText">
        </form>
    </div>
    <div id="success"></div>
    <div id="error"></div>

            
    <!--<div id="searchDiv">
        <h2 class="heading">Search Topic</h2>
        <input type="text" id="searchBox">
    </div>-->

    <div id="loadDiv">
        <table id="loadTable">
            <tr>
                <th>ID</th>
                <th>Cource Name</th>
                <th>Cource Year</th>
                <th>Subject</th>
                <th>Subject Unit</th>
                <th>Title</th>
                <th>Update</th>
                <th>Delete</th>
            </tr>
            <tbody id="tableData">
                
            </tbody>
        </table>
    </div>

    <div id="update_form">
        <form id="update_topicText">
            <div id="one1">
                <label for="up_Cname">Cource Name</label> 
                <select  id="up_Cname">
                    <option value="">select Cource name</option>     
                </select>
                <div id="update_cyear">
                    <label for="up_cyear">Cource year</label>
                   <input type="number" id="up_cyear" min="0" max="4">
                </div>
            </div>
            <div id="two2">
                <label for="up_subject">subjects</label> 
                <select  id="up_subject" >
                    <option value="">select subject</option>     
                </select>
                <div id="update_sunit">
                    <label for="up_sunit">subject Unit</label>
                    <input type="number" id="up_sunit" min="0" max="5">
                </div>
            </div>
            <label for="up_title">Toipc Title<span class="orange">*</span></label>
            <input type="text" id="up_title">
            <br>
            
            <label for="up_h_one">First Heading<span class="orange">*</span></label>
            <input type="text" id="up_h_one" >
            <br>
            <label for="up_t_one">Text body</label> <br>
            <textarea id="up_t_one" cols="30" rows="10" ></textarea>
            <br>
            
            <label for="up_h_two">second Heading</label>
            <input type="text" id="up_h_two" >
            <br>
            <label for="up_t_two">Text body 2</label>
            <br> 
            <textarea id="up_t_two" cols="30" rows="10" ></textarea>
            <br>
            
            <label for="up_h_three">third Heading</label>
            <input type="text" id="up_h_three" >
            <br>
            <label for="up_t_three">Text body 3</label>
            <br>
            <textarea  id="up_t_three" cols="30" rows="10" name="t_three"></textarea>
            <br>
            <input type="submit" value="update ok" id="update_TopicText">
        </form>
    </div>

    <script src="functions.js"></script>
    <script>
        $(document).ready(function(){
            
            //global variables
            var url = "http://localhost/sdms/";
            var c_id = null;
            var c_year = null;
            var s_id = null;
            var s_unit = null;
            var topic_by = null;
            var update_id =null;
            var up_cid = null;
            var up_subid = null;

            //loadData
            function loadTable(){
                $("#tableData").html("");
                $.ajax({
                    url:"http://localhost/sdms/php_files/databaseApi.php?api_id=5",
                    type: "GET",
                    success: function(data){
                        //console.log(data);
                        if(data.status == false){
                            $("#tableData").append("<tr><td><h2>" + data.message + "</h2></td></tr>"); 
                        }else{
                            $.each(data, function(key, value){
                                $("#tableData").append("<tr><td>" + value.tid + "</td><td>" + value.cname + "</td><td>" + value.cyear + "</td><td>" + value.sub_name + "</td><td>" + value.sunit + "</td><td>" + value.title + "</td>"
                                    + "<td> <button class = 'updateBtn' data-idupdate = '" + value.tid + "'>Update</button> </td>" + "<td> <button class = 'deleteBtn' data-idDelete ='" + value.tid + "'>Delete</button> </td>" );
                            });
                        }
                    }
                });
            }
            loadTable();

            //load cources into given select-tag id, set selected-option while updating.  
            function load_cources(select_id, cid) {
                
                $.ajax({
                    url :  url + "php_files/databaseApi.php?api_id=9",
                    type : "GET",
                    success: function(data){
                        //console.log(data);
                        $(select_id).html("<option value =''> select cource </option>");
                        if (data.status == false) {
                            $(select_id).html("<option value =''> no record found </option>");
                            console.log(data.message);
                        }else{
                            $.each(data, function(key, value){
                                if (value.cid == cid) {
                                    var selected = "selected";
                                }else{
                                    selected = "";
                                }
                                $(select_id).append("<option "+ selected +" value ='" + value.cid + "'>" + value.cname + "</option>");
                            });
                        }
                        
                    }
                });
            } 
            load_cources("#Cname");

            //load subjects(s_name) into given select tag id
            function load_subjects(select_id,subid ="",cid = c_id,cyear = c_year) {
                
                var obj = {c_id:cid, c_year:cyear}
                var d = JSON.stringify(obj);
                //console.log(d);
                $.ajax({
                    url :  url + "php_files/databaseApi.php?api_id=10",
                    type : "POST",
                    data : d,
                    success: function(data){
                        $(select_id).html("<option value =''> select subject </option>");
                       if (data.status == false) {
                        $(select_id).html("<option value =''> no record found  </option>");
                        console.log(data.message + " load_subject function die");
                       }else{
                            $.each(data, function(key, value){
                                if (value.subid == subid) {
                                    var selected = "selected";
                                }else{
                                    selected = "";
                                }
                                $(select_id).append("<option "+ selected +" value ='" + value.subid + "'>" + value.sub_name + "</option>");
                            });
                            //console.log(data);
                       }
                    }
                });
            }

            // store selected cName id into  c_id
            $('#Cname').on('change', function () {
                c_id = this.value;        
                //var c_yearText = $(this).find('option').filter(':selected').text();        
                //console.log(c_id);
            });

            //store cource_year and subject_unit into c_year & s_unit 
            $("input[type='radio']").click(function(){
                c_year = $("input[name='c_year']:checked").val();
                s_unit = $("input[name='s_unit']:checked").val();
                //console.log(c_year,s_unit);
            });

            // fetch subjects name according to selected cource year
            $("#cyear input[type='radio']").change(function () {
                load_subjects("#Csubject");
            });

            // store selected subject name id  into s_id
            $('#Csubject').on('change', function () {
                s_id = this.value; 
                //console.log(s_id);       
            });

            // insert topic_text on click save button
            $("#save_TopicText").on("click", function (e) {
                e.preventDefault();

                var title = $("#title").val();
                var h_one = $("#h_one").val();
                var h_two = $("#h_two").val();
                var h_three = $("#h_three").val();
                var t_one = $("#t_one").val();
                var t_two = $("#t_two").val();
                var t_three = $("#t_three").val();
                var obj = {c_id:c_id,c_year:c_year,s_id:s_id,s_unit:s_unit,title:title,h_one:h_one,h_two:h_two,h_three:h_three,t_one:t_one,t_two:t_two,t_three:t_three,topic_by:topic_by};
                
                var j = JSON.stringify(obj);
                //var j = jsonData("#topicText"); (not working [console bug] )
                //console.log(j);
                $.ajax({
                    url : "http://localhost/sdms/php_files/databaseApi_insert.php?api_insert_id=5",
                    type : "POST",
                    data : j,
                    success : function(data){
                        //console.log(data);
                        if (data.status == false) {
                            message(data.message,false);
                            console.log(data);
                        }else if(data.status == true){
                            message("ok",true);
                            loadTable();
                            $("#topicText").trigger("reset");
                        }
                    }
                });
                
            });

            //fetch data for update and pre_set values for change
            $(document).on("click",".updateBtn", function () {
                update_id = $(this).data("idupdate");
                var obj = {id:update_id};
                var Jdata = JSON.stringify(obj);
                $("#update_topicText").trigger("reset");
                $.ajax({
                    url:"http://localhost/sdms/php_files/databaseApi.php?api_id=3",
                    type: "POST",
                    data: Jdata,
                    success: function(data){
                        //console.log(data);
                        up_cid = data[0].cid ;
                        up_subid = data[0].subid;
                        load_cources("#up_Cname",up_cid);
                        load_subjects("#up_subject",up_subid,up_cid, data[0].cyear);
                        //console.log(subid);
                        $("#up_cyear").val(data[0].cyear);
                        $("#up_sunit").val(data[0].sunit);
                        $("#up_title").val(data[0].title);
                        $("#up_h_one").val(data[0].h_one);
                        $("#up_h_two").val(data[0].h_two);
                        $("#up_h_three").val(data[0].h_three);
                        $("#up_t_one").val(data[0].t_one);
                        $("#up_t_two").val(data[0].t_two);
                        $("#up_t_three").val(data[0].t_three);       
                    }
                });
            });

            // store changed updated cource id 
            $('#up_Cname').on('change', function () {
                up_cid = this.value;        
                //var c_yearText = $(this).find('option').filter(':selected').text();        
                //console.log(c_id);
            });

            //fetch subjects according to changes and store changed year value  
            $(document).on("change","#up_cyear", function () {
                var up_cyear = this.value;
                load_subjects("#up_subject",null,up_cid, up_cyear);
                //console.log(up_cyear);
            });
            
            // store updated selected subject name id  into s_id
            $('#up_subject').on('change', function () {
                up_subid = this.value; 
                //console.log(up_subid);       
            });

            // update data
            $("#update_TopicText").on("click", function (e) {
                e.preventDefault();

                var c_id = up_cid;
                var c_year =$("#up_cyear").val();
                var s_id = up_subid;
                var s_unit =$("#up_sunit").val();
                var title = $("#up_title").val();
                var h_one = $("#up_h_one").val();
                var h_two = $("#up_h_two").val();
                var h_three = $("#up_h_three").val();
                var t_one = $("#up_t_one").val();
                var t_two = $("#up_t_two").val();
                var t_three = $("#up_t_three").val();
                
                var obj = {id:update_id, c_id:c_id,c_year:c_year,s_id:s_id,s_unit:s_unit,title:title,h_one:h_one,h_two:h_two,h_three:h_three,t_one:t_one,t_two:t_two,t_three:t_three};
                var Jdata = JSON.stringify(obj);
                //console.log(Jdata);

                $.ajax({
                    url : "http://localhost/sdms/php_files/databaseApi_insert.php?api_insert_id=6",
                    type : "POST",
                    data : Jdata,
                    success : function(data){
                        //console.log(data);
                        if (data.status == false) {
                            message(data.message,false);
                            console.log(data);
                        }else if(data.status == true){
                            message("data updated ok",true);
                            loadTable();
                            $("#update_topicText").trigger("reset");
                        }
                    }
                });
            });
        });//ready
        

    </script>

</body>
</html>